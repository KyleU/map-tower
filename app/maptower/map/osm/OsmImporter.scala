package maptower.map.osm

import scala.xml.pull._
import scala.io.Source
import java.io.File
import com.mongodb.casbah.commons.{ MongoDBObject => Obj, MongoDBList => ObjList }
import com.mongodb.casbah.Imports._
import maptower.data._
import maptower.map._

object OsmImporter {
  def apply(filename: String) = {
    val src = Source.fromFile(new File(filename))
    val er = new XMLEventReader(src)

    var numRecordsProcessed = 0

    var current = Obj.newBuilder
    var tags = ObjList.newBuilder
    var otherColl = ObjList.newBuilder

    while (er.hasNext) {
      er.next match {
        case comment: EvComment => println(comment.text)
        case elem: EvElemStart => {
          val attrs = elem.attrs.asAttrMap
          if (elem.label == "node" || elem.label == "way" || elem.label == "relation") {
            current = Obj.newBuilder
            current += ("osmId" -> attrs("id").toInt)
          }
          elem.label match {
            case "node" => current += ("loc" -> ObjList(attrs("lon").toFloat, attrs("lat").toFloat))
            case "tag" => tags += Obj("k" -> attrs("k"), "v" -> attrs("v"))
            case "nd" => otherColl += attrs("ref").toInt
            case "member" => otherColl += Obj("type" -> attrs("type"), "ref" -> attrs("ref").toInt, "role" -> attrs("role"))

            case "osm" => println("Processing OSM v" + attrs("version") + " generated by " + attrs("generator") + ".")
            case "bound" => println("Importing bounds box: " + attrs("box") + ".")

            case _ =>
          }
        }
        case elem: EvElemEnd => {
          var shouldPersist = false
          elem.label match {
            case "node" => {
              shouldPersist = true
            }
            case "way" => {
              current += "nodes" -> otherColl.result
              otherColl = ObjList.newBuilder
              shouldPersist = true
            }
            case "relation" => {
              current += "members" -> otherColl.result
              otherColl = ObjList.newBuilder
              shouldPersist = true
            }
            case "osm" => println("Finished processing " + numRecordsProcessed + " records.")
            case _ =>
          }
          if (shouldPersist) {
            numRecordsProcessed += 1
            current += "tags" -> tags.result
            tags = ObjList.newBuilder
            osmDao.mongoDb("osm" + elem.label).insert(current.result)
          }
        }
        case _ =>
      }
    }
    numRecordsProcessed
  }
}
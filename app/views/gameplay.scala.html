@(gameType:maptower.game.GameType, username: String)(implicit request: RequestHeader)

@import com.codahale.jerkson.Json._

@headerContent() = {
  <script src="@routes.Assets.at("javascripts/maptower.js")" type="text/javascript"></script>
  <script type="text/javascript">
    window.gameType = @Html(generate(gameType));
  </script>
}

@main("MapTower Test", headerContent) {
  <div id="map"></div>
  <div class="panel" id="info-panel">
    <h3>@gameType.name</h3>
    $<span class="currencyAmount">0</span><br/>
    ...
  </div>
  <div class="panel" id="actions-panel">
      <button class="btn" name="map" value="zoom-in" title="Zoom In">+</button>
      <button class="btn" name="map" value="zoom-out" title="Zoom Out">-</button>
      <button class="btn" name="help" value="general" title="Help">?</button>
  </div>
  <div class="panel" id="debug-panel">
    <h4>Debug Actions</h4>
    <div>
      <button class="btn" name="debug" value="random" title="Who knows? Click it and find out!">Random</button>
      <button class="btn" name="debug" value="clear" title="Clears the map of, well, everything.">Clear Map</button>
      <button class="btn" name="debug" value="reload" title="Reload">Reload</button>
    </div>
  </div>
  <div class="panel" id="log-panel">
    <div id="messages">
    </div>
    <input id="talk" />
  </div>
  <div class="panel" id="options-panel">
    <h4>Theme</h4>
    <div class="theme controls">
      <label class="radio">
        <input type="radio" name="theme" value="standard" checked="checked">
        Standard
      </label>
      <label class="radio">
        <input type="radio" name="theme" value="dark">
        Dark
      </label>
      <label class="radio">
        <input type="radio" name="theme" value="sat">
        Satellite
      </label>
    </div>
    <h4>Options</h4>
    <div>
      <div class="options controls">
        <label class="checkbox">
          <input type="checkbox" name="draw-node" checked="checked">
          Draw Nodes
        </label>
        <label class="checkbox">
          <input type="checkbox" name="draw-way" checked="checked">
          Draw Ways
        </label>
        <label class="checkbox">
          <input type="checkbox" name="draw-bg" checked="checked">
          Draw Tiles
        </label>
      </div>
    </div>
  </div>

  <script type="text/javascript" charset="utf-8">
    $(function() {
      var WS = window['MozWebSocket'] ? MozWebSocket : WebSocket;
      var eventSocket = new WS("@routes.Gameplay.events(gameType.code, username).webSocketURL()");

      var sendMessage = function(obj) {
        console.log("Sending", obj);
        eventSocket.send(JSON.stringify(obj));
      }

      var receiveEvent = function(event) {
        var data = JSON.parse(event.data);
        console.log("Received", event);

        if (data.error) {
          eventSocket.close();
          console.log("ERROR");
          return;
        }

        var el = $('<div class="message"><span></span><p></p></div>');
        $("span", el).text(data.user);
        $("p", el).text(data.message);
        $(el).addClass(data.kind);
        if (data.user == '@username') {
          $(el).addClass('me');
        }
        $('#messages').append(el);
      }

      var handleReturnKey = function(e) {
        if (e.charCode == 13 || e.keyCode == 13) {
          e.preventDefault();
          sendMessage({
            text : $("#talk").val()
          })
          $("#talk").val('');
        }
      }

      $("#talk").keypress(handleReturnKey);

      eventSocket.onmessage = receiveEvent;
    })
  </script>
  
}
